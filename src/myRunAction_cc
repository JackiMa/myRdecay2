#include "RunAction.hh"
#include "PrimaryGeneratorAction.hh"
#include "DetectorConstruction.hh"

#include "G4Run.hh"
#include "G4RunManager.hh"
#include "G4UnitsTable.hh"
#include "G4PhysicalConstants.hh"
#include "G4SystemOfUnits.hh"
#include <iomanip>
#include <fstream>

#include "G4AnalysisManager.hh"

#define OUTFILENAME "./output/data.csv"

// ==1 è¡¨ç¤ºæ¯æ¬¡runä¹‹åæ¸…ç†nuclideTableï¼Œ==0è¡¨ç¤ºç´¯åŠ è®¡æ•°
// å¯¹äºgpsæ¥è¯´ï¼Œä¸€æ¬¡runæ˜¯ä¸€ä¸ªèƒ½è°±ï¼Œæ¯æ¬¡ç»“æœéœ€è¦æ¸…é›¶ã€‚è€Œå¯¹äºgunæ¥è¯´ï¼Œæ›´é€‚åˆç´¯åŠ 
#define isCleanAfterRun 1 

std::map<G4String, G4int> RunAction::nuclideTable;

//....oooOO0OOooo........oooOO0OOooo........oooOO0OOooo........oooOO0OOooo......

RunAction::RunAction()
:G4UserRunAction()
{
    // Create analysis manager
  // The choice of the output format is done via the specified
  // file extension.
  auto analysisManager = G4AnalysisManager::Instance();

  // Create directories
  //analysisManager->SetHistoDirectoryName("histograms");
  //analysisManager->SetNtupleDirectoryName("ntuple");
  analysisManager->SetVerboseLevel(1);
  analysisManager->SetNtupleMerging(true);
    // Note: merging ntuples is available only with Root output

  // Book histograms, ntuple
  //
  // Creating histograms

  analysisManager->CreateH1("E_radiation","Time = 1ns", 1024, 0., 3*MeV,"MeV");
  // analysisManager->CreateH1("E_radiation","Time = 1ns", 1024, 0., 3*MeV); // å ä½
  analysisManager->CreateH1("E_radiation","Time = 1s", 1024, 0, 1*MeV,"MeV");
  analysisManager->CreateH1("E_radiation","Time = 10s", 1024, 0., 3*MeV,"MeV");
  analysisManager->CreateH1("E_radiation","Time = 100s", 1024, 0., 3*MeV,"MeV");
  analysisManager->CreateH1("E_radiation","Time = 1ks", 1024, 0., 3*MeV,"MeV");
  analysisManager->CreateH1("E_radiation","Time = 1ks+", 1024, 0., 3*MeV,"MeV");
  



  // // Creating ntuple
  // //
  // analysisManager->CreateNtuple("Radiation", "Edep");
  // analysisManager->CreateNtupleDColumn("TrackID");
  // analysisManager->CreateNtupleDColumn("GlobalTime");
  // analysisManager->CreateNtupleDColumn("E_radiation");
  // analysisManager->FinishNtuple();
}

//....oooOO0OOooo........oooOO0OOooo........oooOO0OOooo........oooOO0OOooo......

RunAction::~RunAction()
{}
//....oooOO0OOooo........oooOO0OOooo........oooOO0OOooo........oooOO0OOooo......

void RunAction::BeginOfRunAction(const G4Run* aRun)
{ 



if(IsMaster()){
  G4cout << " ### Run "<< aRun->GetRunID() << " start." << G4endl;
  std::ofstream fr;
  fr.open(OUTFILENAME,std::ios::app); // ios::app åœ¨æ–‡ä»¶å°¾è¿½åŠ è¾“å…¥
  fr << "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”  Run ID = "<<aRun->GetRunID() <<"  â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”"<<std::endl;
  fr << "EventID\tParent\tTrack\tStep\tParticle\tEnergy\tTotalEnergy\tProcess"<<std::endl;
  fr.close();

if(isCleanAfterRun){
  // æ¸…ç©ºåˆ—è¡¨ï¼Œå¦‚æœä¸æ¸…ç©ºçš„è¯ï¼Œå¤šæ¬¡runçš„ç»“æœä¼šç´¯åŠ 
  this->nuclideTable.erase(this->nuclideTable.begin(),this->nuclideTable.end()); 
}



}

  // å°è¯•ä½¿ç”¨g4rootæ¥ç”»å›¾
  // Get analysis manager
  auto analysisManager = G4AnalysisManager::Instance();

  // Open an output file
  //
  const DetectorConstruction *detectorConstruction = static_cast<const DetectorConstruction *>(G4RunManager::GetRunManager()->GetUserDetectorConstruction());
  G4String CrystalName = detectorConstruction->CrystalName;
  G4String fileName = CrystalName + ".root";
  // Other supported output types:
  // G4String fileName = "B4.csv";
  analysisManager->OpenFile(fileName);
  G4cout << "Using " << analysisManager->GetType() << G4endl;
  // g4root ğŸ‘†
  

}

//....oooOO0OOooo........oooOO0OOooo........oooOO0OOooo........oooOO0OOooo......

void RunAction::EndOfRunAction(const G4Run* aRun)
{

  if(IsMaster()){
    G4cout << "\n*******************************************"<< G4endl;
    G4cout << "\t\tNumber of event = "<< aRun->GetNumberOfEvent() << G4endl;
    G4cout << "*******************************************\n"<< G4endl;

    std::map<G4String, G4int>::iterator iter = this->nuclideTable.begin();

    G4cout << "å¼€å§‹è¾“å‡ºè®°å½•çš„ç»“æœï¼š" ;
    for (; iter != this->nuclideTable.end(); iter++)
    {
        G4cout << iter->first << '\t' << iter->second << G4endl;
    }
    G4cout << G4endl;
    G4cout << "coutå®Œæ¯•!\n" ;
  }

        // g4root
  auto analysisManager = G4AnalysisManager::Instance();
    // save histograms & ntuple


  G4cout << "------------------------------------" << "\n";
  G4cout << "------------------------------------" << "\n";
  G4cout << "------------------------------------" << "\n";
  G4cout << "------------------------------------" << "\n";
  G4cout << analysisManager->GetH1Nbins(0) << "\n";
  G4cout << analysisManager->WriteH1(1,"testGAGG.csv") << "\n";
  G4cout << "------------------------------------" << "\n";
  G4cout << "------------------------------------" << "\n";
  G4cout << "------------------------------------" << "\n";
  G4cout << "------------------------------------" << "\n";


  analysisManager->Write();
  analysisManager->CloseFile();
  // --------------------------

}


//....oooOO0OOooo........oooOO0OOooo........oooOO0OOooo........oooOO0OOooo......
